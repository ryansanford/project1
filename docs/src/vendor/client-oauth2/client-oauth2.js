(function(root){var _hasOwnProperty=Object.prototype.hasOwnProperty;var btoa=typeof Buffer==="function"?bufferBtoa:root.btoa;var ERROR_RESPONSES={"invalid_request":["The request is missing a required parameter, includes an","invalid parameter value, includes a parameter more than","once, or is otherwise malformed."].join(" "),"invalid_client":["Client authentication failed (e.g., unknown client, no","client authentication included, or unsupported","authentication method)."].join(" "),"invalid_grant":["The provided authorization grant (e.g., authorization",
"code, resource owner credentials) or refresh token is","invalid, expired, revoked, does not match the redirection","URI used in the authorization request, or was issued to","another client."].join(" "),"unauthorized_client":["The client is not authorized to request an authorization","code using this method."].join(" "),"unsupported_grant_type":["The authorization grant type is not supported by the","authorization server."].join(" "),"access_denied":["The resource owner or authorization server denied the request."].join(" "),
"unsupported_response_type":["The authorization server does not support obtaining","an authorization code using this method."].join(" "),"invalid_scope":["The requested scope is invalid, unknown, or malformed."].join(" "),"server_error":["The authorization server encountered an unexpected","condition that prevented it from fulfilling the request.","(This error code is needed because a 500 Internal Server","Error HTTP status code cannot be returned to the client","via an HTTP redirect.)"].join(" "),
"temporarily_unavailable":["The authorization server is currently unable to handle","the request due to a temporary overloading or maintenance","of the server."].join(" ")};function assign(dest){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)if(_hasOwnProperty.call(source,key))dest[key]=source[key]}return dest}function bufferBtoa(string){return(new Buffer(string)).toString("base64")}function expects(obj,props){for(var i=0;i<props.length;i++)var prop=props[i]}function omit(source,
keys){var obj={};Object.keys(source||{}).forEach(function(key){if(keys.indexOf(key)===-1)obj[key]=source[key]});return obj}function encodeComponent(str){return encodeURIComponent(str).replace(/[!'()]/g,root.escape).replace(/\*/g,"%2A")}function decodeComponent(str){return decodeURIComponent(str)}function uriEncode(obj,sep,eq){var params=[];eq=eq||"\x3d";sep=sep||"\x26";Object.keys(obj).forEach(function(key){var value=obj[key];var keyStr=encodeComponent(key)+eq;if(Array.isArray(value))for(var i=0;i<
value.length;i++)params.push(keyStr+encodeComponent(value[i]));else if(value!=null)params.push(keyStr+encodeComponent(value))});return params.join(sep)}function uriDecode(qs,sep,eq){eq=eq||"\x3d";sep=sep||"\x26";qs=qs.split(sep);var obj={};var maxKeys=1E3;var len=qs.length>maxKeys?maxKeys:qs.length;for(var i=0;i<len;i++){var key=qs[i].replace(/\+/g,"%20");var value="";var index=key.indexOf(eq);if(index!==-1){value=key.substr(index+1);key=key.substr(0,index)}key=decodeComponent(key);value=decodeComponent(value);
if(!_hasOwnProperty.call(obj,key))obj[key]=value;else if(Array.isArray(obj[key]))obj[key].push(value);else obj[key]=[obj[key],value]}return obj}function getAuthError(data){var message=ERROR_RESPONSES[data.error]||data.error||data.error_message;return message&&new Error(message)}function getAllReponseHeaders(xhr){var headers={};xhr.getAllResponseHeaders().split("\n").forEach(function(header){var index=header.indexOf(":");if(index===-1)return;var name=header.substr(0,index).toLowerCase();var value=
header.substr(index+1).trim();headers[name]=value});return headers}function getBodyRequest(data,contentType){if(contentType==="application/x-www-form-urlencoded"&&typeof data==="object")return uriEncode(data);return data}function sanitizeScope(scopes){if(!Array.isArray(scopes))return scopes==null?null:String(scopes);return scopes.join(" ")}function ClientOAuth2(options){this.options=options;this.code=this["authorization_code"]=new CodeFlow(this);this.token=this.implicit=new TokenFlow(this);this.owner=
this.password=new OwnerFlow(this);this.credentials=this["client_credentials"]=new CredentialsFlow(this)}ClientOAuth2.Token=ClientOAuth2Token;ClientOAuth2.prototype.createToken=function(access,refresh,type,data){return new ClientOAuth2Token(this,assign({},data,{access_token:access,refresh_token:refresh,token_type:type}))};ClientOAuth2.prototype._request=function(options,done){return this.request(options,function(err,res){if(err)return done(err);if(res.status&&Math.floor(res.status/100)!==2){err=new Error("HTTP Status "+
res.status);err.status=res.status;return done(err)}if(typeof res.body!=="string")return done(null,res.body);try{done(null,JSON.parse(res.body),res.raw)}catch(e){done(null,uriDecode(res.body),res.raw)}})};if(typeof window!=="undefined")ClientOAuth2.prototype.request=function(options,done){var xhr=new root.XMLHttpRequest;var headers=options.headers||{};var body=getBodyRequest(options.data,options.contentType);xhr.open(options.method,options.url);xhr.onload=function(){return done(null,{raw:xhr,status:xhr.status,
headers:getAllReponseHeaders(xhr),body:xhr.responseText})};xhr.onerror=xhr.onabort=function(){return done(new Error(xhr.statusText||"XHR aborted"))};Object.keys(headers).forEach(function(header){xhr.setRequestHeader(header,headers[header])});xhr.send(body)};else{var url=require("url");var http=require("http");var https=require("https");ClientOAuth2.prototype.request=function(options,done){var lib=http;var reqOptions=url.parse(options.url);if(reqOptions.protocol==="https:")lib=https;reqOptions.method=
options.method;reqOptions.headers=options.headers;var req=lib.request(reqOptions,function(res){var data="";res.on("error",done);res.on("data",function(chunk){data+=chunk});res.on("end",function(){return done(null,{raw:res,status:res.statusCode,headers:res.headers,body:data})})});req.on("error",done);req.write(options.body);req.end()}}function ClientOAuth2Token(client,data){this.client=client;this.data=omit(data,["access_token","refresh_token","token_type","expires_in","scope","state","error","error_description",
"error_uri"]);this.tokenType=(data.token_type||"bearer").toLowerCase();this.accessToken=data.access_token;this.refreshToken=data.refresh_token;if(data.expires_in){this.expires=new Date;this.expires.setSeconds(this.expires.getSeconds()+data.expires_in)}}ClientOAuth2Token.prototype.sign=function(options){if(!this.accessToken)throw new Error("Unable to sign without access token");options.headers=options.headers||{};if(this.tokenType==="bearer")options.headers.Authorization="Bearer "+this.accessToken;
else{var parts=options.url.split("#");var token="access_token\x3d"+this.accessToken;var url=parts[0].replace(/[?&]access_token=[^&#]/,"");var fragment=parts[1]?"#"+parts[1]:"";options.url=url+(url.indexOf("?")>-1?"\x26":"?")+token+fragment;options.headers.Pragma="no-store";options.headers["Cache-Control"]="no-store"}return options};ClientOAuth2Token.prototype.request=function(options,done){return this.client.client.request(this.sign(options),done)};ClientOAuth2Token.prototype.refresh=function(done){var self=
this;var options=this.client.options;if(!this.refreshToken)return done(new Error("No refresh token set"));var authorization=btoa(options.clientId+":"+options.clientSecret);return this.client._request({url:options.accessTokenUri,method:"POST",headers:{"Accept":"application/json, application/x-www-form-urlencoded","Content-Type":"application/x-www-form-urlencoded","Authorization":"Basic "+authorization},data:uriEncode({refresh_token:this.refreshToken,grant_type:"refresh_token"})},function(err,data){if(err||
(err=getAuthError(data)))return done(err);self.accessToken=data.access_token;self.refreshToken=data.refresh_token;return done(null,self)})};ClientOAuth2Token.prototype.expired=function(){if(this.expires)return Date.now()<this.expires.getTime();return false};function OwnerFlow(client){this.client=client}OwnerFlow.prototype.getToken=function(username,password,done){var self=this;var options=this.client.options;var authorization=btoa(options.clientId+":"+options.clientSecret);return this.client._request({url:options.accessTokenUri,
method:"POST",headers:{"Accept":"application/json, application/x-www-form-urlencoded","Content-Type":"application/x-www-form-urlencoded","Authorization":"Basic "+authorization},data:uriEncode({scope:sanitizeScope(options.scopes),username:username,password:password,grant_type:"password"})},function(err,data){if(err||(err=getAuthError(data)))return done(err);return done(null,new ClientOAuth2Token(self,data))})};function TokenFlow(client){this.client=client}TokenFlow.prototype.getUri=function(options){options=
assign({},this.client.options,options);expects(options,["clientId","redirectUri","authorizationUri"]);return options.authorizationUri+"?"+uriEncode({state:options.state,scope:sanitizeScope(options.scopes),client_id:options.clientId,redirect_uri:options.redirectUri,response_type:"token"})};TokenFlow.prototype.getToken=function(url,state,done){var options=this.client.options;var err;if(typeof state==="function"){done=state;state=null}if(url.substr(0,options.redirectUri.length)!==options.redirectUri)return done(new Error("Invalid url (should to match redirect): "+
url));var queryString=url.replace(/^[^\?]*|\#.*$/g,"").substr(1);var fragmentString=url.replace(/^[^\#]*/,"").substr(1);if(!queryString&&!fragmentString)return done(new Error("Unable to process url: "+url));var data=assign(queryString?uriDecode(queryString):{},fragmentString?uriDecode(fragmentString):{});if(err=getAuthError(data))return done(err);if(state&&data.state!==state)return done(new Error("Invalid state:"+data.state));return done(null,new ClientOAuth2Token(this,data))};function CredentialsFlow(client){this.client=
client}CredentialsFlow.prototype.getToken=function(options,done){var self=this;if(typeof options==="function"){done=options;options=null}options=assign({},this.client.options,options);expects(options,["clientId","clientSecret","accessTokenUri"]);var authorization=btoa(options.clientId+":"+options.clientSecret);return this.client._request({url:options.accessTokenUri,method:"POST",headers:{"Accept":"application/json, application/x-www-form-urlencoded","Content-Type":"application/x-www-form-urlencoded",
"Authorization":"Basic "+authorization},data:uriEncode({scope:sanitizeScope(options.scopes),grant_type:"client_credentials"})},function(err,data){if(err||(err=getAuthError(data)))return done(err);return done(null,new ClientOAuth2Token(self,data))})};function CodeFlow(client){this.client=client}CodeFlow.prototype.getUri=function(options){options=assign({},this.client.options,options);expects(options,["clientId","redirectUri","authorizationUri"]);return options.authorizationUri+"?"+uriEncode({state:options.state,
scope:sanitizeScope(options.scopes),client_id:options.clientId,redirect_uri:options.redirectUri,response_type:"code"})};CodeFlow.prototype.getToken=function(url,state,done){var self=this;var options=this.client.options;var err;if(typeof state==="function"){done=state;state=null}expects(options,["clientId","clientSecret","redirectUri","accessTokenUri"]);if(url.substr(0,options.redirectUri.length)!==options.redirectUri)return done(new Error("Invalid url (should to match redirect): "+url));var queryString=
url.replace(/^[^\?]*|\#.*$/g,"").substr(1);if(!queryString)return done(new Error("Unable to process url: "+url));var query=uriDecode(queryString);if(err=getAuthError(query))return done(err);if(state&&query.state!==state)return done(new Error("Invalid state:"+query.state));if(!query.code)return done(new Error("Missing code, unable to request token"));return this.client._request({url:options.accessTokenUri,method:"POST",headers:{"Accept":"application/json, application/x-www-form-urlencoded","Content-Type":"application/x-www-form-urlencoded"},
data:uriEncode({code:query.code,grant_type:"authorization_code",redirect_uri:options.redirectUri,client_id:options.clientId,client_secret:options.clientSecret})},function(err,data,raw){if(err||(err=getAuthError(data)))return done(err,null,raw);return done(null,new ClientOAuth2Token(self,data),raw)})};if(typeof define==="function"&&define.amd)define([],function(){return ClientOAuth2});else if(typeof exports==="object")module.exports=ClientOAuth2;else root.ClientOAuth2=ClientOAuth2})(this);